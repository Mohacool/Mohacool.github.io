<!DOCTYPE html>
  <html lang="en">
    <head>
      <link href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css" rel="stylesheet">
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
      <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
      
  </head>
  <body>
    <div class="container">
        <h1>Recording Test</h1>

        <button id="record">Record</button>
        <button id="stoprec">Stop</button>
        <div id="ok"></div>
        <div id="plot" style="height:1px">
            <img src="/freqSpectrum.png">
        <div id="plot" style="height:1px">
            <img src="/audio.png">
        <div id="plot" style="height:1px">
            <img src="/mainFreqs.png">
        </div>

    </div>
    <script>

        // ------------------- RECORDING ------------------
        var recordings = [];
        var myBuffer;
        
        record.onclick = () =>{
            navigator.mediaDevices.getUserMedia({audio:true})
            .then(stream => {

                mediaRecorder = new MediaRecorder(stream)
                mediaRecorder.start()
                chuck = []

                mediaRecorder.addEventListener("dataavailable", e => {
                    chuck.push(e.data);
                })
                mediaRecorder.addEventListener("stop", e =>{
                    blob = new Blob(chuck, {'type': 'audio/wav;'})

                    recordings.push(blob); // Add blob to list of recordings 
                    chuck = [];
                  

                    // NEW CODE STARTS HERE
                    fileReader = new FileReader();
                    audioContext = new AudioContext();
                    let arrayBuffer;

                    fileReader.onloadend = () => {
                        arrayBuffer = fileReader.result;
                        audioContext.decodeAudioData(arrayBuffer, (audioBuffer) => {
                            console.log(audioBuffer)  //just displays the audioBuffer on the console
                            myBuffer = audioBuffer;
                        })
                    }

                    fileReader.readAsArrayBuffer(blob) // NEW CODE ENDS HERE
                })




            })


        }

        stoprec.onclick = () =>{
            mediaRecorder.stop()
        }

        // ------------------- RECORDING END ------------------


        // USE THIS FUNCTION 
        function sendBuffer(){

            var anotherArray = new Float32Array(myBuffer.length);
            myBuffer.copyFromChannel(anotherArray, 0);
            //console.log("rate"+ myBuffer.sampleRate);

            var send = [anotherArray,myBuffer.sampleRate];

            // Send the sample rate
            $.ajax({
                type: 'POST',
                url: 'http://localhost:5000/samplerate',
                data: myBuffer.sampleRate,
                cache: false,
                processData: false,  // prevent jQuery from converting the data
                contentType: false,  // prevent jQuery from overriding content type
                success: function(response) {
                    alert(response);
                }
            });

            // Send the audio message
            $.ajax({
                type: 'POST',
                url: 'http://localhost:5000/messages',
                data: anotherArray,
                cache: false,
                processData: false,  // prevent jQuery from converting the data
                contentType: false,  // prevent jQuery from overriding content type
                success: function(response) {
                    alert(response);
                    // get response
                }
            });

            


            
        }
        ////////////////////////////////////////////////////////////////////////////////
        // CODE THAT SENDS SINGLE AJAX REQUEST

        function sendBuffer2(){

            signal = new Float32Array(myBuffer.length);
            myBuffer.copyFromChannel(signal, 0, 0);
            signalArr = Array.from(signal)
            sampleRate = myBuffer.sampleRate

            $.ajax({
                data : {audio : signalArr, sampleRate : sampleRate},
                type : 'POST',
                url: 'http://localhost:5000/messages2',
                dataType: "json",
                
            })


            
            .done(function(data){
                if (data.error){
                    console.log("error")
                }
                else{
                    console.log("success")
                    $('notes').text(data.notes).show();
                    alert("success")
                    alert(data.notes)
                }
            })





        }
        ////////////////////////////////////////////////////////////////////////////////
    

        

    </script>
    
  </body>
</html>
